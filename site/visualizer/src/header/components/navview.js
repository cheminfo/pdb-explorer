"use strict";define(["jquery","superagent","src/header/components/default","src/util/versioning","forms/button","src/util/util","fancytree","components/ui-contextmenu/jquery.ui-contextmenu.min","jquery-ui/dialog"],function(a,b,c,d,e,f){function g(){}function h(a){return a.map(function(a){return{title:a.name,folder:a.isDir,lazy:a.isDir,key:a.rel+a.name,data:{url:a.url,path:a.rel+a.name,dir:a.rel}}})}function i(b){return new Promise(function(c){var d=a("#ci-dialog");0===d.length&&(d=a("<div/>").css("id","ci-dialog"),a("body").append(d)),d.html(b),d.dialog({modal:!0,buttons:{Cancel:function(){a(this).dialog("close")},Ok:function(){c(!0),a(this).dialog("close")}},close:function(){return c(!1)},width:400})})}return f.inherits(g,c,{initImpl:function(){var b=this;this.id=f.getNextUniqueId(),a.ui.fancytree.debugLevel=0,a(document).keydown(function(a){return(a.ctrlKey||a.metaKey)&&83==a.which?(a.preventDefault(),b.checkNode(),b.save(),!1):void 0})},_onClick:function(){this.createMenu()},createMenu:function(){var b=this;this.$_elToOpen||(this.$_elToOpen=a("<div/>").css("width",550)),this.setStyleOpen(this._open),this._open?(this.$tree||(this.$tree=this.$tree||a("<div/>").css("id",this.cssId("tree")).css("display","inline-block").css("margin-right",20),this.$_elToOpen.append('<div><p><label>Filter:</label><input name="search" placeholder="Filter..."><button id="btnResetSearch" disabled="disabled">Ã—</button><span id="matches"></span></p></div>'),this.$_elToOpen.append(this.$tree)),this.open(),this.initTree().then(function(){b.createButtons()})):this.close()},cssId:function(a){return"ci-navview-header-"+this.id+"-"+a},reloadTree:function(){this.$tree.fancytree("destroy"),this.initTree(!0)},reloadActiveNode:function(){this.reloadNode(this.$tree.fancytree("getActiveNode"))},reloadNode:function(a){if(a.isFolder()||(a=a.getParent()),a.isRoot())return void this.reloadTree();var b=a.isExpanded();a.load(!0).then(function(){b&&a.setExpanded(!0,{noAnimation:!0})})},getDir:function(a){return a.replace(new RegExp(/\/[^\/]+$/),"/")},load:function(a){},save:function(){var b,c,e=this;if(this.activeNode)b=this.getDir(this.activeNode.data.path),c=this.activeNode.title;else{if(!this.viewURL)return;b=this.getDir(this.viewURL),b=b.replace(/^\/views/,".");var f=this.viewURL.lastIndexOf("/");c=f>-1?this.viewURL.slice(f+1):this.viewURL}i("You are about to save the current view to: "+b+c+"<br/>This operation will erase the previous content of this file and cannot be undone.").then(function(f){if(f){var g=a.ajax({url:"/navview/save",data:{dir:b,name:c,content:d.getViewJSON("	")},type:"POST",dataType:"json"});g.done(function(){e.log("success-log","Successfully saved view"),e.reloadActiveNode()}),g.fail(function(){e.log("error-log","Failed to save view")})}})},mkdir:function(){var b=this,c=this.activeNode.data.path;this.activeNode.isFolder()||(c=this.getDir(c));var d=this.getFormContent(this.$dirnameInput);if(c&&d){var e=a.ajax({url:"/navview/mkdir",type:"POST",data:{dir:c,name:d},dataType:"json"});e.done(function(){b.log("success-log","Successfully created directory"),b.reloadActiveNode()}),e.fail(function(){b.log("error-log","Failed create directory")})}},remove:function(b){var c=this;if(b.isFolder())return this.log("error-log","Failed remove file");var d=this.getDir(b.data.path),e=b.title;i("<p>You are about to remove the file: <br/>"+b.data.path+"</p>Do you really want to do this? You cannot undo this operation").then(function(f){if(f){var g=a.ajax({url:"/navview/file",type:"DELETE",data:{dir:d,name:e},dataType:"json"});g.done(function(){b.remove(),c.log("success-log","Successfully removed file")}),g.fail(function(){c.log("error-log","Failed remove file")})}})},removeDir:function(b){var c=this;return b.isFolder()?void i("<p>You are about to remove the directory: <br/>"+b.data.path+"</p>Do you really want to do this? You cannot undo this operation").then(function(d){if(d){var e=a.ajax({url:"/navview/dir",type:"DELETE",data:{dir:b.data.path},dataType:"json"});e.done(function(){b.remove(),c.log("success-log","Successfully removed directory")}),e.fail(function(){c.log("error-log","Failed remove directory")})}}):this.log("error-log","Failed remove directory")},rename:function(){var a=this,b=new RegExp(/(^.*)\/([^\/]+$)/),c=b.exec(this.activeNode.data.path);if(3===!c.length)return void this.log("error-log","Invalid path...");var d=c[1],e=this.getFormContent("docName"),f=d,g=c[2],h=this.ajaxRename({dir:d,newDir:f,name:g,newName:e});h.done(function(){a.log("success-log","Successfully renamed file"),a.reloadActiveNode()}),h.fail(function(){a.log("error-log","Failed to rename file")})},ajaxRename:function(b){return a.ajax({url:"/navview/rename",type:"PUT",data:b,dataType:"json"})},inlineRename:function(a){var b=this,c={dir:a.data.dir,newDir:a.data.dir,newName:a.title,name:b.inlineOldTitle},d=this.ajaxRename(c);d.done(function(){a.setTitle(a.title),b.log("success-log","Successfully renamed file")}),d.fail(function(){a.setTitle(b.inlineOldTitle),b.log("error-log","Failed to rename file")})},newFile:function(){var b=this,c=b.activeNode.data.path;b.activeNode.isFolder()||(c=b.getDir(c));var d=a.ajax({url:"/navview/touch",type:"POST",data:{dir:c,name:b.getFormContent(this.$filenameInput)},dataType:"json"});d.done(function(){b.log("success-log","File successfully created"),b.reloadActiveNode()}),d.fail(function(){b.log("error-log","Failed to create new file")})},duplicate:function(){},checkNode:function(){this.activeNode||this.log("error-log","Error: you must select a node");var a=location.search.split("viewURL=")[1];a=decodeURIComponent(a),this.viewURL=a},log:function(a,b){if(this.$log){var c=this.$log.find("#"+this.cssId(a));c.length>0&&(this.currentLogTimeout&&clearTimeout(this.currentLogTimeout),this.$log.find("div").html(""),c.html(b)),this.currentLogTimeout=setTimeout(function(){c.html("")},5e3)}},loadRootTree:function(){return this.treeSchema?this.treeSchema:a.ajax({url:"/navview/list",dataType:"json"})},initTree:function(b){var c=this;return!b&&c.fancytreeOk?Promise.resolve():this.loadRootTree().then(function(b){var e=h(b);c.$tree.fancytree({toggleEffect:!1,extensions:["edit","filter"],filter:{mode:"dimm"},source:e,lazyLoad:function(b,c){c.result=a.ajax({url:"/navview/list?dir="+c.node.data.path,dataType:"json"}).then(h)},activate:function(a,b){c.activeNode=b.node,c.updateSaveViewText()},dblclick:function(a,b){d.switchView({view:{url:b.node.data.url}},!0)},keydown:function(a,b){switch(a.preventDefault(),a.which){case 8:b.node.isFolder()?c.removeDir.apply(c,[b.node]):c.remove.apply(c,[b.node])}},edit:{triggerStart:["f2","shift+click","mac+enter"],beforeEdit:function(a,b){return b.node.isFolder()?!1:void(c.inlineOldTitle=b.node.title)},edit:function(a,b){},beforeClose:function(a,b){},save:function(b,d){return d.node.setTitle(d.input.val()),a(d.node.span).addClass("pending"),c.inlineRename.apply(c,[d.node]),!0},close:function(b,c){c.save&&a(c.node.span).addClass("pending")}}}),c.fancytreeOk=!0;var f=c.$tree.fancytree("getTree");c.$_elToOpen.find("input[name=search]").keyup(function(b){var c,d=a(this).val();return b&&b.which===a.ui.keyCode.ESCAPE||""===a.trim(d)?void a("button#btnResetSearch").click():(c=f.filterNodes(d,!1),a("button#btnResetSearch").attr("disabled",!1),void a("span#matches").text("("+c+" matches)"))}).focus(),a("button#btnResetSearch").click(function(){a("input[name=search]").val(""),a("span#matches").text(""),f.clearFilter()}).attr("disabled",!0)})},createButtons:function(){var b=this;if(!this._buttons){this.$log=a("<div/>").attr("id",this.cssId("log")).css("margin-bottom",10),this.$_elToOpen.append("<div/>").children(":gt(1)").css("display","inline-block").css("vertical-align","top").append(this.$log),this.$log.append(a("<div/>").attr("id",this.cssId("error-log")).css("color","red")),this.$log.append(a("<div/>").attr("id",this.cssId("success-log")).css("color","green")),this.$log.parent().append(new e("Refresh Tree",function(){b.reloadTree()},{color:"blue"}).render()),this.$log.parent().append('<br/><br/><br/><div>\n    <ul>\n        <li style="color:black;">Double-click a view to load it</li>\n        <li style="color: black;">Shift+click to rename a view</li>\n        <li style="color: black;">Press delete key to remove a view or a directory</li>\n    </ul>\n</div>');var c=a('<div>\n    <table>\n        <tr>\n            <td></td>\n            <td></td>\n        </tr>\n        <tr>\n            <td><input type="text"/></td>\n            <td></td>\n        </tr>\n        <tr>\n            <td><input type="text"/></td>\n            <td></td>\n        </tr>\n    </table>\n</div>');this.$_elToOpen.append(c);var d=c.find("input");this.$dirnameInput=a(d[0]),this.$filenameInput=a(d[1]);var f=c.find("td");this.$saveViewText=a(f[0]),a(f[1]).append(new e("Save view",function(){b.checkNode(),b.save()},{color:"red"}).render()),a(f[3]).append(new e("Mkdir",function(){b.checkNode(),b.mkdir()},{color:"blue"}).render()),a(f[5]).append(new e("New file",function(){b.checkNode(),b.newFile()},{color:"blue"}).render()),this._buttons=!0}},updateSaveViewText:function(){this.$saveViewText.html(this.activeNode.data.path)},getFormContent:function(b){return"string"==typeof b?a("#"+this.cssId(b)).val().trim():b instanceof jQuery?b.val().trim():void 0},setFormContent:function(b,c){a("#"+this.cssId(b)).val(c)}}),g});