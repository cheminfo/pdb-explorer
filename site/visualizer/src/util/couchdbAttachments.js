"use strict";define(["src/util/versioning","superagent","src/util/lru"],function(a,b,c){function d(a){for(var b,c=Math.min(100,a.length),d=0;c>d;d++)if(";"===a[d]){b=d+1;break}var e=a.slice(b,b+7);if(b&&"base64,"===e)return b+=7,a.slice(b);throw new Error("Could not parse dataurl")}function e(a,c){return a.list().then(function(){if(!Array.isArray(c))throw new TypeError("Argument should be an array");return 0===c.length?a.list():new Promise(function(d,e){for(var f=0;f<c.length;f++)delete a.lastDoc._attachments[c[f]];b.put(a.docUrl).set("Content-Type","application/json").set("Accept","application/json").send(a.lastDoc).end(function(a,b){return a?e(a):201!==b.status?e(new Error("Error uploading inline attachments, couchdb returned status code "+b.status)):d()})})}).then(function(){return a.refresh()})}function f(a,b){var c=[],d=0;for(var e in b)c.push(b[e]),c[d].name=e,c[d].url=encodeURI(a.docUrl+"/"+e),d++;return a.lastAttachmentsResult=c,c}var g="__couchdb-attachments",h=200,i=500;c.exists(g)||c.create(g,h,i);var j=function(){if(this._hasFetched=!1,0===arguments.length){var b=a.lastLoaded.view.url;if(!b)throw new Error("couchdb attachments initialization failed: No view url");this.docUrl=b.replace(/\/[^\/]+$/,""),this.url=""}else this.docUrl=arguments[0]};return j.prototype.list=function(a){var b=this;return Promise.resolve().then(function(){var c=b.lastDoc&&b.lastDoc._attachments;if(!c&&a)throw new Error("Unexpected error: List of attachments not available");return c?f(b,b.lastDoc._attachments):b.refresh().then(function(){return b.list(!0)})})},j.prototype.uploads1=function(a){var c=this;if(!Array.isArray(a))throw new Error("uploads expects an array as parameter");return Promise.resolve().then(function(){return new Promise(function(d,e){for(var f=b.post(c.docUrl),g=0;g<a.length;g++){var h=a[g];f.attach("_attachments",h,h.name)}f.field("_rev",c.lastDoc._rev),f.end(function(a,b){return a?e(a):(201!==b.status&&e(new Error("Error uploading attachments, couchdb returned status code "+b.status)),d())})})}).then(function(){return c.refresh()})},j.prototype.inlineUploads=function(a){var c=this,e=this.list();return a?e.then(function(){if(!Array.isArray(a))throw new TypeError("options must be an array");for(var b=[],e=0;e<a.length;e++)!function(e){var f=a[e];if(f.data)c.lastDoc._attachments[f.name]={content_type:f.contentType,data:btoa(unescape(encodeURIComponent(f.data)))};else if(f.file&&"string"==typeof f.file){var g=/data:([a-z]+\/[a-z]+);base64,(.+)/.exec(f.file);if(!g)throw new Error("File is string but not valid base64 encoded dataURL");c.lastDoc._attachments[f.name]={content_type:g[1],data:g[2]}}else{if(!(f.file&&f.file instanceof Blob))return Promise.reject(new Error("Item must have a valid data or file property"));var h=new Promise(function(a,b){var c=new FileReader;c.onload=function(b){return a({item:f,base64data:d(b.target.result)})},c.onerror=function(){return b("Error while reading file")},c.readAsDataURL(f.file)});b.push(h)}}(e);return Promise.all(b)}).then(function(a){return new Promise(function(d,e){for(var f=0;f<a.length;f++){var g=a[f];c.lastDoc._attachments[g.item.name]={content_type:g.item.contentType,data:g.base64data}}b.put(c.docUrl).set("Content-Type","application/json").set("Accept","application/json").send(c.lastDoc).end(function(a,b){return a?e(a):201!==b.status?e(new Error("Error uploading inline attachments, couchdb returned status code "+b.status)):d()})})}).then(function(){return c.refresh()}):e.then(function(){return f(this,this.lastAttachmentsResult)})},j.prototype.upload=function(a){var d=this;return this.list().then(function(){if(!a)throw new Error("Invalid arguments");return new Promise(function(c,e){var f=d.lastDoc._attachments[a.name],g=a.contentType||(f?f.content_type:void 0);return g?void b.put(d.docUrl+"/"+a.name).query({rev:d.lastDoc._rev}).set("Content-Type",g).set("Accept","application/json").send(a.data||a.file).end(function(a,b){return a?e(a):201!==b.status?e(new Error("Error uploading attachment, couchdb returned status code "+b.status)):(d.lastDoc._rev=b.body.rev,c())}):e(new Error("Content-Type unresolved. Cannot upload document without content-type"))})}).then(function(){var b=d.refresh();return a.data&&b.then(function(){c.store(g,d.lastDoc._attachments[a.name].digest,a.data)}),b})},j.prototype.get=function(a){var d=this;return this.list().then(function(){var e=d.lastDoc._attachments[a];if(!e)throw new Error("The attachment "+a+" does not exist");return Promise.resolve(c.get(g,e.digest)).then(function(a){return a?a.data:{}},function(){return new Promise(function(f,h){var i=b.get(d.docUrl+"/"+a);e&&i.set("Accept",d.lastDoc._attachments[a].content_type),i.query({rev:d.lastDoc._rev}).end(function(a,b){return a?h(a):200!==b.status?h(new Error("Error getting attachment, couchdb returned status code "+b.status)):(c.store(g,e.digest,b.body||b.text),f(b.body||b.text))})})})})},j.prototype.remove=function(a){var c=this;return Array.isArray(a)?e(this,a):this.list().then(function(){if(!c.lastDoc._attachments[a])throw new Error("Cannot remove attachment, attachment does not exist.");return new Promise(function(d,e){b.del(c.docUrl+"/"+a).query({rev:c.lastDoc._rev}).set("Accept","application/json").end(function(b,g){return b?e(b):200!==g.status?e(new Error("Error deleting attachment, couchdb returned status code "+g.status)):(c.lastDoc._rev=g.body.rev,delete c.lastDoc._attachments[a],d(f(c,c.lastDoc._attachments)))})})})},j.prototype.refresh=function(){var a=this;return new Promise(function(c,d){b.get(a.docUrl).set("Accept","application/json").end(function(b,e){return b?d(b):200!==e.status?d(new Error("Error getting document, couchdb returned status code "+e.status)):(a.lastDoc=e.body,a._hasFetched=!0,c(f(a,e.body._attachments)))})})},j.prototype.fetchList=j.prototype.refresh,j});