"use strict";require.config({paths:{svgsanitize:"lib/svg-edit-2.7/sanitize"},shim:{svgsanitize:["lib/svg-edit-2.7/svgedit","lib/svg-edit-2.7/browser","lib/svg-edit-2.7/svgutils"],"lib/svg-edit-2.7/svgutils":["lib/svg-edit-2.7/browser","lib/svg-edit-2.7/svgtransformlist","lib/svg-edit-2.7/units"],"lib/svg-edit-2.7/svgtransformlist":["lib/svg-edit-2.7/browser"]}}),define(["require","src/util/api","lodash","modules/default/defaultview","src/util/debug","src/util/typerenderer","src/util/util","src/util/datatraversing","lib/svg-edit-2.7/embedapi","svgsanitize"],function(a,b,c,d,e,f){function g(){var a=this;this.svgCanvas=null,this.iframeLoaded=$.Deferred(),this.iframeLoaded.done(function(){a.svgCanvas.zoomChanged(window,"canvas")})}var h=c.throttle(function(){function a(a){c[0].module.definition.configuration.groups.group[0].svgcode=[a],c[0].module.controller.onChange(a)}function b(b,c){return c?void e.error("Unable to get svg from iframe"):void a(b)}var c=arguments;if(c[0]._configCheckBox("editable","isEditable"))setTimeout(function(){c[0].svgCanvas.getSvgString()(b)},0);else{var d=c[0].dom.clone(),f=d[0].getAttribute("viewBox").split(" ");d.attr("width",f[2]).attr("height",f[3]).removeAttr("viewBox"),d=d.wrap("<p/>").parent().html(),a(d)}},1e3),i=["animate","set","animateMotion","animateColor","animateTransform"],j={begin:"indefinite",options:{clearOnEnd:!1,persistOnEnd:!1,clearAnimationTagsOnEnd:!1,clearAnimationTagsBeforeBegin:!1}},k=["options","tag","attributes"],l=["click","dblclick","mouseenter","mouseleave"],m={},n={},o={};return $.extend(!0,g.prototype,d,{init:function(){var a=this;if(this._configCheckBox("editable","isEditable"))this.dom&&this.dom.remove(),this.svgCanvas=null,this.dom=$('<iframe src="lib/svg-edit-2.7/svg-editor.html?extensions=ext-xdomain-messaging.js'+window.location.href.replace(/\?(.*)$/,"&$1")+'"></iframe>'),this.module.getDomContent().html(this.dom),this.dom.bind("load",function(){var b=a.dom[0];a.svgCanvas=new EmbeddedSVGEdit(b),a.iframeDoc=b.contentDocument||b.contentWindow.document,a.svgEditor=b.contentWindow.svgEditor,b.contentWindow.svgedit.options={},a.svgCanvas.bind("changed",function(){a.svgEditor.showSaveWarning=!1,a._saveSvg()}),a._loadSvg(),a.iframeLoaded.resolve(),a.resolveReady(),a.onResize()});else{var b=a.module.getDomContent();f.render(b,{type:"svg",value:a.module.getConfiguration("svgcode")}).catch(function(){b.html("<svg></svg>")}).then(function(){a.dom=b.find("svg"),a.resolveReady()})}},onResize:function(){this._configCheckBox("editable","isEditable")&&this.dom&&(this.dom.height(this.height).width(this.width),this.svgCanvas&&this.svgCanvas.zoomChanged(window,"canvas"))},update:{svgModifier:function(a){this.modifySvgFromArray(a,!0)}},addAnimation:function(a,b){var d=this,f=$([]);if(b.attributes){a.attr("id");if(b.tag=b.tag||"animate",-1!==i.indexOf(b.tag)){Array.isArray(b.attributes)||(b.attributes=[b.attributes]),b=c.defaults(b,j);var g=d.getHighlightId(a),h={};for(var l in b)-1===k.indexOf(l)&&(h[l]=c.cloneDeep(b[l]));for(var m=0;m<b.attributes.length;m++){b.attributes[m]=c.defaults(b.attributes[m],h),a.each(function(){var a=document.createElementNS("http://www.w3.org/2000/svg",b.tag);for(var c in b.attributes[m]){var d=b.attributes[m][c];d="function"==typeof d?d.call():d,a.setAttributeNS(null,c,d)}$(this).append(a)});var p=a.children(":last-child");f=f.add(p)}f.each(function(c,h){this.addEventListener("endEvent",function(){if(o[g]=!1,b.options.persistOnEnd&&("animate"===b.tag?a.attr(this.getAttribute("attributeName"),this.getAttribute("to")):e.warn("Could not persist animation")),b.options.clearAnimationTags&&d.$getAnimationTags(a).remove(),b.options.clearOnEnd){var c=b.options.clearOnEnd.timeout||0;setTimeout(function(){$(h).remove(),d._saveSvg()},c)}}),this.addEventListener("repeatEvent",function(){}),this.addEventListener("beginEvent",function(){b.options.clearAnimationTagsBeforeBegin&&(d.$getAnimationTags(a).not(f).remove(),n[g]=0,o[g]=!0)}),"indefinite"===this.getAttribute("begin")&&this.beginElement()})}}},addAnimations:function(a,b){if(Array.isArray(b))for(var c=0;c<b.length;c++)this.addAnimation(a,b[c]);else this.addAnimation(a,b)},setAttributesOneByOne:function(a,b){for(var c in b)"function"==typeof b[c]?a.each(function(){this.setAttribute(c,b[c].call())}):a.attr(c,b[c])},removeStyleProperties:function(a,b){a.each(function(){for(var a in b)this.style.removeProperty(a)})},modifySvgFromArray:function(a,b){var c=this;Array.isArray(a)||(a=[a]),this._configCheckBox("editable","isEditable")?this.$svgcontent=$(c.iframeDoc).find("#svgcontent"):this.$svgcontent=c.dom,c.module._data=[];for(var d=0;d<a.length;d++)this.modifySvgFromObject(a[d],b);c._saveSvg()},modifySvgFromObject:function(a,d){function f(){$(this).css("cursor","pointer"),j.module.controller.onHover(a.info||{})}function g(){$(this).css("cursor","default")}function h(){j.module.controller.onClick(a.info||{})}function i(a){if(!o[t]){var b={};b.tag="animateTransform",b.options={clearOnEnd:!1,persistOnEnd:!1},b.attributes={attributeName:"transform",type:"scale",from:"1.0",dur:"0.2s",additive:"sum",accumulate:"sum",fill:"freeze"},a&&0===n[t]?(b.options.clearAnimationTags=!1,b.attributes.to="1.25",n[t]++):a||1!==n[t]||(b.options.clearAnimationTags=!1,b.attributes.to="0.8",n[t]--),j.addAnimation(p,b)}}var j=this,k=a.selector;if(k){var m="string"==typeof a._highlight;a.info&&(j.module._data=a.info);var p,q=this.$svgcontent;if(p=q.find(k),0===p.length&&(p=q.find("#"+k)),0===p.length)return void e.warn("The svg element to modify was not found",k);if(a.innerVal&&p.html(a.innerVal),a.attributes&&!a.animation)c.any(a.attributes,function(a){return"function"==typeof a})?this.setAttributesOneByOne(p,a.attributes):p.attr(a.attributes),j.removeStyleProperties(p,a.attributes);else if(a.animation&&!a.attributes)j.addAnimations(p,a.animation);else if(a.attributes&&a.animation&&!a.animation.attributes){a.animation.attributes=[];for(var r in a.attributes){var s={};s.attributeName=r,s.to=a.attributes[r],a.animation.attributes.push(s)}delete a.attributes,j.addAnimations(p,a.animation)}else a.attributes&&a.animation&&a.animation.attributes&&(p.attr(a.attributes),j.removeStyleProperties(p,a.attributes),j.addAnimations(p,a.animation));if(d){if(m){var t=j.getHighlightId(p);b.killHighlight(t),b.listenHighlight({_highlight:a._highlight},i,!1,t),n[t]=n[t]||0}!function(b){b.off("mouseenter.svgeditor.varout").off("mouseleave.svgeditor.varout").off("click.svgeditor.varout"),a.info&&b.on("mouseenter.svgeditor.varout",f).on("mouseleave.svgeditor.varout",g).on("click.svgeditor.varout",h);for(var c=0;c<l.length;c++)a.hasOwnProperty(l[c])&&!function(c){b.off(c),b.on(c,function(){a[c].selector||(a[c].selector=a.selector),j.modifySvgFromArray(a[c],!0)})}(l[c])}(p)}}},getHighlightId:function(a){a.map(function(){return this.getAttribute("id")}).toArray().join(",")},_clearEventCallbacks:function(a){for(var b=0;b<a.length;b++)if(a.selector)for(var c=0;c<l.length;c++)$(a.selector).off(l[c]+".svgeditor.svgmodifier")},getDom:function(){return this.dom},_loadSvg:function(){var a=this.module.getConfiguration("svgcode");this.svgCanvas.setSvgString(a),this.module.controller.onChange(a)},_saveSvg:function(){h(this)},_configCheckBox:function(a,b){return this.module.getConfiguration(a)&&c.find(this.module.getConfiguration(a),function(a){return a===b})},memorizeAnim:function(a,b){b&&a.attributes&&a.attributes.to&&a.attributes.attributeName&&(m[b]=m[b]||{},m[b][a.attributes.attributeName]=m[b][a.attributes.attributeName]||{},m[b][a.attributes.attributeName].to=a.attributes.to)},rememberAnim:function(a,b){a.attributes&&!a.attributes.from&&b&&m[b]&&m[b][a.attributes.attributeName]&&m[b][a.attributes.attributeName].to&&(a.attributes.from=m[b][a.attributes.attributeName].to)},$getAnimationTags:function(a){for(var b,c=0;c<i.length;c++)b=0===c?a.find(i[c]):b.add(a.find(i[c]));return b}}),g});