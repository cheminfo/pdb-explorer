"use strict";define(["require","lodash","modules/default/defaultview","src/util/api","src/util/debug"],function(a,b,c,d,e){function f(){}function g(){this.lastHoveredAtom&&(d.highlightId(this.lastHoveredAtom.label,0),this.lastHoveredAtom=null)}var h={};window.addEventListener("message",function(a){try{var b=JSON.parse(a.data)}catch(a){return}if("jsmol"===b.module){var c=b.id;if(!h[c])return void e.error("No view with ID "+c);var d,f=h[c];switch(b.type){case"ready":f.resolveReady();break;case"message":f.module.controller.onNewMessage(b.message);break;case"atomClick":d=f.parseAtom(b.message),f.module.controller.onAtomClick(d);break;case"atomHover":d=f.parseAtom(b.message),f._doHighlights(d),f.module.controller.onAtomHover(d);break;case"error":e.warn("An error message was received",b.message);break;case"execSync":f.module.controller.onSyncExecDone(b.message);break;default:e.error("Message type not handled: ",b.type)}}}),$.extend(!0,f.prototype,c,{init:function(){var b=this,c=this.module.getId();h[c]=this,this.dom=$("<iframe>",{src:a.toUrl("./jsmol.html")}).css("border",0),this.module.getDomContent().html(this.dom).css("overflow","hidden"),this._highlights=this._highlights||[],this.dom.bind("load",function(){b.postMessage("init",{id:c})})},onResize:function(){this.dom.height(this.height).width(this.width),this.postMessage("setSize",{width:this.width,height:this.height})},inDom:function(){var a=this;this.dom.parent().on("mouseleave",function(){a.lastHoveredAtom&&(d.highlightId(a.lastHoveredAtom.label,0),a.lastHoveredAtom=null)})},blank:{data:function(){this.postMessage("blank","")}},update:{data:function(a){var b=this;this.module.data=a,b.postMessage("setMolFile",{_modelLoad:a.get(),_lattice:a._lattice,_script:a._script}),b.module.getConfiguration("script")&&b.postMessage("executeScript",[b.module.getConfiguration("script")]),b.module.getConfiguration("syncScript")&&b.postMessage("executeScriptSync",[b.module.getConfiguration("syncScript")]),this._activateHighlights()}},onActionReceive:{jsmolscript:function(a){this.executeScript(a)},jsmolscriptSync:function(a){this.executeScriptSync(a)}},executeScriptSync:function(a){this.postMessage("executeScriptSync",[a])},executeScript:function(a){this.postMessage("executeScript",[a])},postMessage:function(a,b){var c=this.dom.get(0).contentWindow;c&&c.postMessage(JSON.stringify({type:a,message:b}),"*")},remove:function(a){delete h[a]},parseAtom:function(a){var b=/^([^\s]+)\s+([^\s]+)\s+([-+]?[0-9]*\.?[0-9]+)\s+([-+]?[0-9]*\.?[0-9]+)\s+([-+]?[0-9]*\.?[0-9]+)/,c=b.exec(a);return{id:c[2],label:c[1],x:c[3],y:c[4],z:c[5]}},_doHighlights:function(a){if(this.lastHoveredAtom){if(this.lastHoveredAtom.label===a.label)return void this._undoHighlightsDebounced();d.highlightId(this.lastHoveredAtom.label,0)}this._undoHighlights(),d.highlightId(a.label,1),this.lastHoveredAtom=a,this._undoHighlightsDebounced()},_undoHighlights:function(){g.call(this)},_undoHighlightsDebounced:function(){i.call(this)},_activateHighlights:function(){var a=this;if(this.module.data._highlight){var c=b(this.module.data._highlight).flatten().uniq().value();a._highlighted=[],d.killHighlight(this.module.getId());for(var e=0;e<c.length;e++)!function(e){d.listenHighlight({_highlight:c[e]},function(c,d){!d instanceof Array&&(d=[d]),c?a._highlighted=b(a._highlighted).push(d).flatten().uniq().value():a._highlighted=b.filter(a._highlighted,function(a){return-1===d.indexOf(a)}),a._drawHighlight()},!1,a.module.getId())}(e)}},_drawHighlight:function(){var a="select *.*; halos off;";this._highlighted&&this._highlighted.length&&(a+="select "+this._highlighted.join(",")+"; halos on;"),this.executeScript(a)}});var i=b.debounce(g,250);return f});