"use strict";define(["modules/default/defaultview","jsgraph","src/util/datatraversing","src/util/api","src/util/color","src/util/debug"],function(a,b,c,d,e,f){function g(){}function h(a){if(Array.isArray(a)){var b,c,d,e=1/0,f=-(1/0);if("number"==typeof a[0])for(c=0,d=a.length-2;d>c;c+=2)b=a[c+2]-a[c],b>f&&(f=b),e>b&&(e=b);else for(c=0,d=a.length-1;d>c;c++)b=a[c+1][0]-a[c][0],b>f&&(f=b),e>b&&(e=b);return Math.abs(e/f)<.9?"discrete":"continuous"}}return $.extend(!0,g.prototype,a,{init:function(){this.series={},this.seriesDrawn={},this.annotations={},this.dom=$("<div />"),this.zones={},this.module.getDomContent().html(this.dom),this.seriesActions=[],this.colorId=0,this.colors=["red","blue","green","black"],this.deferreds={},this.onchanges={}},inDom:function(){var a=this,c=new Promise(function(c){var d=a.module.getConfiguration.bind(a.module),e=a.module.getConfigurationCheckbox.bind(a.module),f=d("graphurl");if(f)$.getJSON(f,{},function(d){d.options.onMouseMoveData=function(b,c){a.module.controller.sendAction("mousetrack",c)},c(new b(a.dom.get(0),d.options,d.axis))});else{var g={close:{left:!1,right:!1,top:!1,bottom:!1},plugins:{},pluginAction:{}},h=d("zoom");if(h&&"none"!==h){var i={};"x"===h?i.zoomMode="x":"y"===h?i.zoomMode="y":i.zoomMode="xy",g.plugins.zoom=i,g.plugins.drag={},g.pluginAction.zoom={shift:!1,ctrl:!1},g.pluginAction.drag={shift:!0,ctrl:!1},g.dblclick={type:"plugin",plugin:"zoom",options:{mode:"total"}}}var j=d("wheelAction");if(j&&"none"!==j){var k={baseline:d("wheelbaseline",0)};"xAxis"===j?k.direction="x":k.direction="y",g.wheel={type:"plugin",plugin:"zoom",options:k}}e("mouseTracking","track")&&(g.onMouseMoveData=function(b,c){a.module.model.trackData=c,a.module.controller.sendActionFromEvent("onTrackMouse","trackData",c),a.module.controller.createDataFromEvent("onTrackMouse","trackData",c)}),e("selectScatter","yes")&&(g.plugins.selectScatter={},g.pluginAction.selectScatter={shift:!1,ctrl:!1,alt:!0});var l=new b(a.dom.get(0),g),m={};"timestamptotime"==d("xaxismodification")?m.type="time":"valtotime"==d("xaxismodification")?m.unitModification="time":"valtotime:min.sec"==d("xaxismodification")&&(m.unitModification="time:min.sec");var n=l.getXAxis(null,m);n.flip(e("flipAxis","flipX")).setPrimaryGrid(e("grid","vmain")).setSecondaryGrid(e("grid","vsec")).setLabel(d("xLabel","")).forceMin(d("minX",!1)).forceMax(d("maxX",!1)).setAxisDataSpacing(d("xLeftSpacing",0),d("xRightSpacing",0)),e("displayAxis","x")||n.hide(),n.on("zoom",function(b,c){a.module.model.setXBoundaries(b,c)}),e("FitYToAxisOnFromTo","rescale")&&n.on("zoom",function(){o.scaleToFitAxis(this)});var o=l.getYAxis();o.flip(e("flipAxis","flipY")).setPrimaryGrid(e("grid","hmain")).setSecondaryGrid(e("grid","hsec")).setLabel(d("yLabel","")).forceMin(d("minY",!1)).forceMax(d("maxY",!1)).setAxisDataSpacing(d("yBottomSpacing",0),d("yTopSpacing",0)),e("displayAxis","y")||o.hide(),o.on("zoom",function(b,c){a.module.model.setYBoundaries(b,c)});var p=d("legend","none");if("none"!==p){var q,r,s,t,u=l.makeLegend({backgroundColor:"rgba( 255, 255, 255, 0.8 )",frame:!0,frameWidth:"1",frameColor:"rgba( 100, 100, 100, 0.5 )",movable:!0});switch(p){case"topright":q="right",r="top",s="max",t="max";break;case"bottomright":q="right",r="bottom",s="max",t="min";break;case"topleft":q="left",r="top",s="min",t="max";break;case"bottomleft":q="left",r="bottom",s="min",t="min"}e("flipAxis","flipX")&&(s="min"===s?"max":"min"),e("flipAxis","flipY")&&(t="min"===t?"max":"min"),u.setPosition({dx:"0px",dy:"0px",x:s,y:t},q,r)}c(l)}});c.then(function(b){a.graph=b,a.xAxis=b.getXAxis(),a.yAxis=b.getYAxis(),b.on("shapeMouseOver",function(b){a.module.controller.createDataFromEvent("onMouseOverShape","shapeInfos",b.getData()),d.highlight(b.getData(),1)}),b.on("shapeMouseOut",function(a){d.highlight(a.getData(),0)}),b.shapeHandlers.onAfterResized.push(function(b){a.module.model.dataTriggerChange(b.getData())}),b.on("shapeSelect",function(b){a.module.controller.createDataFromEvent("onShapeClick","shapeInfos",b.getData()),a.module.controller.sendActionFromEvent("onShapeSelect","selectedShape",b.getData())}),b.on("shapeUnselect",function(b){a.module.controller.createDataFromEvent("onShapeClick","shapeInfos",b.getData()),a.module.controller.sendActionFromEvent("onShapeUnselect","shapeInfos",b.getData())}),a.onResize(),a.resolveReady()}).catch(function(a){f.error("Error loading the graph",a)})},onResize:function(){this.graph&&(this.graph.resize(this.width,this.height),this.redraw(!0))},shouldAutoscale:function(a){return this.seriesDrawn[a]?!1:(this.seriesDrawn[a]=!0,!0)},redraw:function(a,b){var c=this.module.getConfiguration("fullOut");b&&"once"===c&&(c=this.shouldAutoscale(b)?"both":"none"),a?this.graph.autoscaleAxes():"none"==c||("xAxis"==c?this.xAxis.setMinMaxToFitSeries():"yAxis"==c?this.yAxis.setMinMaxToFitSeries():this.graph.autoscaleAxes()),this.graph.draw();var d=this.xAxis.getCurrentMin(),e=this.xAxis.getCurrentMax(),f=this.yAxis.getCurrentMin(),g=this.yAxis.getCurrentMax();this.module.model.setXBoundaries(d,e),this.module.model.setYBoundaries(f,g)},doZone:function(a,b,c,d){if(c&&!b[2]){var e=this.graph.makeShape({type:"rect",pos:{x:b[0]},pos2:{x:b[1]},fillColor:d,opacity:"0.5"});e.setFullHeight(),b.push(e)}else b[2]&&!c&&(b[2].kill(),b.splice(2,1))},getSerieOptions:function(a,b,c){var e=this,f=this.module.getConfiguration("plotinfos");b=b||[];var g={trackMouse:!0};if(f)for(var i=0,j=f.length;j>i;i++)if(a==f[i].variable){var k=f[i].plotcontinuous;"auto"===k&&(k=h(c)),f[i].markers[0]&&(g.markersIndependant=!0),g.lineToZero="discrete"==k,g.useSlots=f[i].optimizeSlots?!!f[i].optimizeSlots[0]:!1,g.strokeWidth=parseInt(f[i].strokewidth);var l=f[i].peakpicking[0];l&&(g.lineToZero?g.autoPeakPicking=!0:g.autoPeakPicking="continuous")}return g.onMouseOverMarker=function(a,c,f){d.highlightId(b[a[0]],1),e.module.controller.onMouseOverMarker(f,c)},g.onMouseOutMarker=function(a,c,f){d.highlightId(b[a[0]],0),e.module.controller.onMouseOutMarker(f,c)},g.onToggleMarker=function(a,b,c){e.module.controller.onClickMarker(a,b,c)},g},setSerieParameters:function(a,b,c,f){var g=this.module.getConfiguration("plotinfos");if(g)for(var h=0,i=g.length;i>h;h++)if(b==g[h].variable){var j=f?f:g[h].plotcolor;a.setLineColor(e.getColor(j));var k=parseFloat(g[h].strokewidth);isNaN(k)&&(k=1),a.setLineWidth(k),a.setLineStyle(parseInt(g[h].strokestyle)||1),g[h].markers[0]&&a.showMarkers&&(a.showMarkers(),a.setMarkers([{type:parseInt(g[h].markerShape),zoom:g[h].markerSize,strokeColor:e.getColor(j),fillColor:e.getColor(j),points:"all"}])),g[h].monotoneous&&g[h].monotoneous[0]&&a.XIsMonotoneous(),g[h].degrade&&a.degrade(g[h].degrade)}c&&d.listenHighlight({_highlight:c},function(b,d){for(var e=0,f=d.length;f>e;e++)for(var g=d[e],h=0,i=c.length;i>h;h++){var j=c[h];if(Array.isArray(j))for(var k=0;k<j.length;k++)j[k]==g&&a.toggleMarker([h,0],!!b,!0);else j==g&&a.toggleMarker([h,0],!!b,!0)}},!1,this.module.getId())},blank:{xyArray:function(a){this.removeSerie(a)},xArray:function(a){this.removeSerie(a)},series_xy1d:function(a){this.removeSerie(a)},jcamp:function(a){this.removeSerie(a)},chart:function(a){this.removeSerie(a)},annotations:function(a){this.removeAnnotations(a)}},update:{chart:function(a,b){this.series[b]=this.series[b]||[],this.removeSerie(b),a=a.get();for(var c=[],d=this,f=a.data,g=0;g<f.length;g++){var h=f[g];0===g&&a.axis&&(a.axis[h.xAxis]&&this.xAxis.setLabel(a.axis[h.xAxis].name),a.axis[h.yAxis]&&this.yAxis.setLabel(a.axis[h.yAxis].name));var i=h.label||b;c.indexOf(i)>-1&&(i+="-"+g),c.push(i);var j=[];switch(h.type){case"zone":if(h.yMin&&h.yMax)for(var k=0,l=h.yMax.length;l>k;k++)j.push(h.x?h.x[k]:k),j.push(h.yMin[k],h.yMax[k]);break;case"contour":j=h.contourLines;break;default:if(h.y)for(var k=0,l=h.y.length;l>k;k++)j.push(h.x?h.x[k]:k),j.push(h.y[k])}var m=this.graph.newSerie(i,this.getSerieOptions(b,h._highlight,j),h.type||void 0);if(this.normalize(j,b),m.setData(j),h.info&&(m.infos=h.info),m.autoAxis(),"scatter"===String(h.type)){if(this.module.getConfigurationCheckbox("selectScatter","yes")){var n=this.graph.getPlugin("selectScatter");n.setSerie(m),function(a){n.on("selectionEnd",function(b){var c=[],e=a.infos;e&&(c=e.filter(function(a,c){return b.indexOf(c)>=0})),d.module.controller.onScatterSelection(c)})}(m)}}else{var o=f.length>1?e.getNextColorRGB(g,f.length):null;this.setSerieParameters(m,b,h._highlight,o)}this.series[b].push(m)}this.redraw(!1,b)},xyArray:function(a,b){if(this.series[b]=this.series[b]||[],this.removeSerie(b),a){var c=a.get(),d=this.graph.newSerie(b,this.getSerieOptions(b,null,c));this.normalize(c,b),d.setData(c),d.autoAxis(),this.setSerieParameters(d,b),this.series[b].push(d),this.redraw(!1,b)}},xArray:function(a,b){var c=a.get();this.series[b]=this.series[b]||[],this.removeSerie(b);for(var d=this.module.getConfiguration("minX",0),e=this.module.getConfiguration("maxX",c.length-1),f=(e-d)/(c.length-1),g=[],h=0,i=c.length;i>h;h++)g.push(d+f*h),g.push(c[h]);var j=this.graph.newSerie(b,this.getSerieOptions(b,null,g));this.normalize(g,b),j.setData(g),j.autoAxis(),this.setSerieParameters(j,b),this.series[b].push(j),this.redraw(!1,b)},annotations:function(a,b){this.annotations[b]=this.annotations[b]||[];for(var c=a.get(),e=0,f=c.length,g=this;f>e;e++)!function(a){var e=c[a],f=g.graph.newShape(e.type,e);g.annotations[b][a]=f,f.setSerie(g.graph.getSerie(0)),d.listenHighlight(e,function(a){a?f.highlight({fill:"black"}):f.unHighlight()},!1,g.module.getId()+b),g.module.model.dataListenChange(c.traceSync([a]),function(a){f.redraw()},"annotations"),f.draw(),f.redraw()}(e)},jcamp:function(a,b){if(a){a=String(a.get());var c,e=this;if(d.killHighlight(this.module.getId()+b),this.graph){this.zones[b]=a._zones,e.deferreds[b]&&e.deferreds[b].reject(),e.deferreds[b]=$.Deferred();var f=e.deferreds[b];require(["jcampconverter"],function(g){g.convert(a,{lowRes:1024},!0).then(function(g){if("rejected"!=f.state()){if(e.deferreds[b]=!1,e.series[b]=e.series[b]||[],e.series[b]=[],g.contourLines)c=e.graph.newSerie(b,e.getSerieOptions(b),"contour"),c.setData(g.contourLines),c.autoAxis(),e.setSerieParameters(c,b),e.series[b].push(c);else{g=g.spectra;for(var h=0,i=g.length;i>h;h++){var j=g[h].data[g[h].data.length-1];c=e.graph.newSerie(b,e.getSerieOptions(b,null,j)),e.normalize(j,b),c.setData(j),c.autoAxis(),e.setSerieParameters(c,b),e.series[b].push(c);break}d.listenHighlight(a._highlight||[],function(a,c){for(var d=0;d<c.length;d++)e.zones[b][c[d]]&&e.doZone(b,e.zones[b][c[d]],a,e.series[b].options.lineColor)},!0,e.module.getId()+b)}e.redraw(!1,b)}})})}}},series_xy1d:function(a,b){var c=this;require(["src/util/color"],function(d){for(var e=d.getDistinctColors(a.length),f=0,g=a.length;g>f;f++){var h=c.getSerieOptions(b,null,a[f].data),i=c.graph.newSerie(a[f].name,h);i.autoAxis(),c.series[b].push(i),a[f].data&&i.setData(a[f].data),i.setLineWidth(a[f].lineWidth||h.strokeWidth||1),i.setLineColor(a[f].lineColor||"rgb("+e[f].join()+")"),i.setLineWidth(3,"selected"),i.extendStyles()}c.redraw()})}},setOnChange:function(a,b,c){this.onchanges[b]&&this.onchanges[b].obj.unbindChange(this.onchanges[b].id),this.onchanges[b]={obj:c,id:a}},removeAnnotations:function(a){if(d.killHighlight(this.module.getId()+a),this.annotations[a])for(var b=0;b<this.annotations[a].length;b++)this.annotations[a][b].kill();this.annotations[a]=[]},removeSerie:function(a){if(this.series[a])for(var b=0;b<this.series[a].length;b++)this.series[a][b].kill(!0);this.series[a]=[]},makeSerie:function(a,b,c){var d=this,e=this.graph.newSerie(a.name);a.onChange(function(){e.setData(a.data),d.graph.draw()}),this.onActionReceive.removeSerieByName.call(this,a.name||{}),e.autoAxis(),e.setData(a.data),this.seriesActions.push([b,e,a.name]),this.setSerieParameters(e,c),a.lineColor&&e.setLineColor(a.lineColor),a.lineWidth&&e.setLineWidth(a.lineWidth),this.redraw()},onActionReceive:{fromToX:function(a){this.xAxis.zoom(a.from,a.to),this.graph.draw()},fromToY:function(a){this.yAxis.zoom(a.from,a.to),this.graph.draw()},addSerie:function(a){if(this.colorId++,a.name)this.makeSerie(a,a,a.name);else for(var b in a)this.makeSerie(a[b],a)},removeSerie:function(a){for(var b=0,c=this.seriesActions.length;c>b;b++)this.seriesActions[b][0]==a&&(this.seriesActions[b][1].kill(),this.seriesActions.splice(b,1))},removeSerieByName:function(a){for(var b=0;b<this.seriesActions.length;b++)this.seriesActions[b][2]==a&&(this.seriesActions[b][1].kill(),this.seriesActions.splice(b,1),b--)},selectSerie:function(a){var b=this.graph.getSerie(a.valueOf());b&&b.select("selected")},unselectSerie:function(a){var b=this.graph.getSerie(a.valueOf());b&&b.unselect()}},normalize:function(a,b){var c,d,e,f,g,h,i=this.module.getConfiguration("plotinfos");if(i){var j="";for(g=0,h=i.length;h>g;g++)b==i[g].variable&&(j=i[g].normalize);if(j)if(Array.isArray(a[0])){if("max1"==j||"max100"==j){var k=1;for("max100"==j&&(k=100),c=-(1/0),g=0;g<a.length;g++)a[g][1]>c&&(c=a[g][1]);for(g=0;g<a.length;g++)a[g][1]/=c/k}else if("sum1"==j){for(e=0,g=0;g<a.length;g++)e+=a[g][1];for(g=0;g<a.length;g++)a[g][1]/=e}else if("max1min0"==j){for(c=-(1/0),d=1/0,g=0;g<a.length;g++)a[g][1]>c&&(c=a[g][1]),a[g][1]<d&&(d=a[g][1]);for(f=1/(c-d),g=0;g<a.length;g++)a[g][1]=(a[g][1]-d)*f}}else if("max1"==j||"max100"==j){var k=1;for("max100"==j&&(k=100),c=-(1/0),g=1;g<a.length;g+=2)a[g]>c&&(c=a[g]);for(g=1;g<a.length;g+=2)a[g]/=c/k}else if("sum1"==j){for(e=0,g=1;g<a.length;g+=2)e+=a[g];for(g=1;g<a.length;g+=2)a[g]/=e}else if("max1min0"==j){for(c=-(1/0),d=1/0,g=1;g<a.length;g+=2)a[g]>c&&(c=a[g]),a[g]<d&&(d=a[g]);for(f=1/(c-d),g=1;g<a.length;g+=2)a[g]=(a[g]-d)*f}}}}),g});