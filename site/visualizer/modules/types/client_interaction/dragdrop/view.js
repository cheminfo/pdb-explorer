"use strict";define(["modules/default/defaultview","bowser","src/util/debug"],function(a,b,c){function d(){}function e(a){return new Promise(function(b){function d(a){if(h=a,j&&a.stop(),navigator.mozGetUserMedia)k.mozSrcObject=h;else{var b=window.URL||window.webkitURL;k.src=b.createObjectURL(h)}k.play()}function e(){l.width=m,l.height=n,l.getContext("2d").drawImage(k,0,0,m,n),f=l.toDataURL("image/png")}i||(i=$("<div/>"),$("body").append(i));var f=null;i.html(a);var g=!1,k=document.querySelector("#video"),l=document.querySelector("#canvas"),m=320,n=0;navigator.getMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,navigator.getMedia({video:!0,audio:!1},d,function(a){c.error("An error occured! "+a)}),k.addEventListener("canplay",function(a){g||(n=k.videoHeight/(k.videoWidth/m),k.setAttribute("width",m),k.setAttribute("height",n),l.setAttribute("width",m),l.setAttribute("height",n),g=!0)},!1),j=!1,i.dialog({modal:!0,buttons:{Cancel:function(){$(this).dialog("close")},"Take Picture":function(){e(),b(f),$(this).dialog("close")}},close:function(){return h?(h.stop(),b(f)):b(!1)},width:400})})}b.mobileos=b.ios||b.android||b.blackberry||b.firefoxos||b.webos||!1;var f=!!(navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia),g=!b.mobileos&&f;$.extend(!0,d.prototype,a,{init:function(){var a=this,b=$("<input/>").css("display","none").attr({type:"file",multiple:!0}),c=this.module.getConfiguration("capture");if(c&&"none"!==c)switch(b.attr("capture",c),c){case"camera":b.attr("accept","image/*");break;case"camcorder":b.attr("accept","video/*");break;case"microphone":b.attr("accept","audio/*")}var d=$("<textarea>").css({position:"absolute",top:0,left:0,height:0,width:0,opacity:0}).on("paste",function(b){b.preventDefault(),b.stopPropagation(),a.module.controller.open(b.originalEvent.clipboardData)}),f=this.module.getConfiguration("label");this.messages={default:f,drag:this.module.getConfiguration("dragoverlabel")||f,hover:this.module.getConfiguration("hoverlabel")||f},this.messageP=$("<div>").css("display","inline-block").html(this.messages.default),this.dom=$("<div />",{class:"dragdropzone"}).html(this.messageP).on("click mousemove",function(){d.focus()}).mouseout(function(){d.blur()}).append(d),this.dom.on("click",function(c){c.stopPropagation(),g&&a.module.getConfigurationCheckbox("getusermedia","yes")?e($('<video id="video"></video><canvas id="canvas" style="display:none;"></canvas>')).then(function(b){b&&b&&a.module.controller.openPhoto(b)}):b.click()}),b.on("change",function(b){a.module.controller.open(a.module.controller.emulDataTransfer(b))}),b.on("load",function(a){}),this.module.getDomContent().html(this.dom)},inDom:function(){var a=this,b=this.dom.get(0),c=0;b.addEventListener("mouseenter",function(b){b.stopPropagation(),b.preventDefault(),a.messageP.html(a.messages.hover),a.dom.addClass("dragdrop-over")}),b.addEventListener("dragenter",function(b){c++,b.stopPropagation(),b.preventDefault(),1===c&&(a.messageP.html(a.messages.drag),a.dom.addClass("dragdrop-over"))}),b.addEventListener("dragover",function(a){a.stopPropagation(),a.preventDefault()}),b.addEventListener("dragleave",function(b){c--,b.stopPropagation(),b.preventDefault(),c||(a.messageP.html(a.messages.default),a.dom.removeClass("dragdrop-over"))}),b.addEventListener("mouseleave",function(b){b.stopPropagation(),b.preventDefault(),a.messageP.html(a.messages.default),a.dom.removeClass("dragdrop-over")}),b.addEventListener("drop",function(b){c=0,b.stopPropagation(),b.preventDefault(),a.module.controller.open(b.dataTransfer)}),this.resolveReady()},onResize:function(){var a=this.dom.first("div"),b=this.dom.parent().parent();a.css("font-size",26);var c=26;if(c){var d=45;for(this.module.domHeader.is(":visible")||(d=20);b.height()-d<a.height()&&c>2;)a.css("font-size",--c)}}});var h,i,j=!0;return d});