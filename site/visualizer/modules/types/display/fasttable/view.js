"use strict";define(["modules/default/defaultview","src/util/util","src/util/api","src/util/domdeferred","src/util/datatraversing","src/util/context"],function(a,b,c,d,e,f){function g(){}return $.extend(!0,g.prototype,a,{init:function(){var a,c=this,d=this.module.getConfiguration("toggle");this.domTable=$("<table />",{cellpadding:0,cellspacing:0}).css({width:"100%"}),this.domHead=$("<thead />").appendTo(this.domTable),this.domBody=$("<tbody />").appendTo(this.domTable),this.selected=[],this.domTable.on("mouseenter","tbody tr",function(){var a=$(this).index();isNaN(a)||c.module.controller.lineHover(c.module.data,a)}).on("mouseleave","tbody tr",function(){var a=$(this).index();isNaN(a)||c.module.controller.lineOut(c.module.data,a)}).on("click","tr",function(){var a=$(this);if(c.module.controller.lineClick(c.module.data,a.index()),d){"single"==d&&void 0!==c.selected[0]&&(c.module.controller.onToggleOff(c.module.data,c.selected[0]),a.parent().children().eq(c.selected[0]).toggleClass("toggled"),c.selected=[]);var b=a.index();a.hasClass("toggled")?c.module.controller.onToggleOff(c.module.data,b):c.module.controller.onToggleOn(c.module.data,b),a.toggleClass("toggled"),c.selected.push(b)}}).on("click","th",function(){var b=$(this).attr("data-jpath-number"),d=c.module.getDataFromRel("list");a&&a.col===b?a.col===b&&(a.asc=!a.asc,a.span.toggleClass("up")):(a&&c.domTable.find('th[data-jpath-number="'+a.col+'"] .sort').remove(),a={asc:!0,col:b,span:$('<div class="sort up"></div>')},c.domTable.find('th[data-jpath-number="'+a.col+'"]').append(a.span)),d.sort(function(d,f){return(a.asc?1:-1)*(c.jpaths[e[b].jpath](d)>c.jpaths[e[b].jpath](f)?1:-1)}),c.module.model.dataTriggerChange(d),c.blank.list.call(c),c.update.list.call(c,d)}),this.dom=this.domTable,this.module.getDomContent().html(this.dom),this.onResize();var e=this.module.getConfiguration("colsjPaths"),f=e.length,g=0;this.colsjPaths=e,this.jpaths={};for(var h="<tr>";f>g;g++)e[g].jpath&&(b.addjPathFunction(this.jpaths,e[g].jpath),h+='<th data-jpath-number="'+g+'">'+e[g].name+"</th>");h+="</tr>";var i=this.module.getConfiguration("colorjPath");i&&(this.colorjpath=b.makejPathFunction(i)),this.domHead.html(h),this.resolveReady()},unload:function(){this.module.getDomContent().empty()},applyFilterToRow:function(a,b){this.filter&&this.filter(this.jqGrid,this.elements[a],b)},blank:{list:function(){if(this.domBody&&this.domBody.empty(),this.module.data){var a,b=this.module.data.length;for(a=0;b>a;a++)this.module.data[a]&&this.module.data[a].unbindChange&&this.module.data[a].unbindChange(this.module.getId())}}},update:{list:function(a){if("string"!==a.type&&a){this.selected=[],this.elements=a;var b=this,d=(this.module.getConfiguration("nbLines")||20,""),e=0,g=a.get().length;for(this.module.data=a,e=0;g>e;e++)d+=this.buildElement(a.getChildSync([e]),e);this.domBody.html(d),this.timeout&&window.clearTimeout(this.timeout),this.timeout=window.setTimeout(function(){for(c.killHighlight(b.module.getId()),e=0;g>e;e++)!function(a){c.listenHighlight(b.module.data[a],function(c){b.doHighlight(a,c)},!1,b.module.getId());var d=b.domBody.find("#"+b.module.getId()+"_"+a);b.module.model.dataListenChange(b.module.data.get(a),function(){d.replaceWith(d=$(b.buildElement(this,a,!0)))},"list"),b.module.data.get(a).removable&&f.listen(d.get(0),[['<li><a><span class="ui-icon ui-icon-close"></span> Remove</a></li>',function(){b.onActionReceive.removeRowById.call(b,a)}]])}(e)},1e3),this.list=!0,this.showList=!1,this.updateVisibility()}},showList:function(a){Array.isArray(a)&&(this.showList=a,this.updateVisibility())}},updateVisibility:function(){if(this.showList&&this.list)for(var a,b=this.showList,c=b.length,d=this.module.getId()+"_",e=0;c>e;e++)a=document.getElementById(d+e),b[e]?a.removeAttribute("style"):a.setAttribute("style","display:none")},buildElement:function(a,b){var c,d,f,g=this.colsjPaths,h="",i=g.length;for(h+="<tr",this.colorjpath&&(f=this.colorjpath(a),Array.isArray(f)&&(f=3===f.length?"rgb("+f.join(",")+")":"rgba("+f.join(",")+")"),h+=' style="background-color: '+f+';"'),h+=' id="'+this.module.getId()+"_"+b+'" ',h+=">",c=0;i>c;c++)g[c].jpath&&(h+="<td>",d=e.get(this.getValue(e.get(a),g[c].jpath)),"undefined"==typeof d&&(d=""),h+=d,h+="</td>");return h+="</tr>"},doHighlight:function(a,b){this.domBody.find("tr").eq(a)[b?"addClass":"removeClass"]("ci-highlight")},getValue:function(a,b){return this.jpaths[b]?this.jpaths[b](a):""},getDom:function(){return this.dom},onActionReceive:{addRow:function(a){if(this.elements=this.elements||[],!(this.module.getDataFromRel("list").indexOf(a)>-1)){this.module.getDataFromRel("list").push(a);var b=this.elements.length-1,c=this.buildElement(a,b);this.domBody.append(c)}},removeRow:function(a){this.onActionReceive.removeRowById.call(this,this.module.getDataFromRel("list").indexOf(a))},removeRowById:function(a){if(!(0>a)){var b=this.module.getDataFromRel("list").splice(a,1);b[0].unbindChange(this.module.getId());var c;(c=this.selected.indexOf(a))>-1&&this.selected.splice(c,1),this.domBody.children().eq(a).remove()}},toggleOff:function(a){var b=this.module.getDataFromRel("list").indexOf(a);-1!=b&&(this.module.controller.onToggleOff(this.module.data,b),this.domBody.children().eq(b).removeClass("toggled"))},toggleOn:function(a){var b=this.module.getDataFromRel("list").indexOf(a);if(-1!=b){var c=this.module.getConfiguration("toggle"),d=this;"single"==c&&void 0!==d.selected[0]&&(d.module.controller.onToggleOff(d.module.data,d.selected[0]),d.domBody.children().eq(d.selected[0]).toggleClass("toggled"),d.selected=[]),d.selected.push(b),this.module.controller.onToggleOn(this.module.data,b),this.domBody.children().eq(b).addClass("toggled")}},scrollTo:function(a){var b=this.module.getDataFromRel("list").indexOf(a);if(-1!=b){var c=this.domBody.children().eq(b).get();c.scrollIntoView()}}},exportToTabDelimited:function(){if(this.colsjPaths){for(var a=[],b=0,c=this.elements.length,d=this.colsjPaths,f=[],g=0;g<d.length;g++)f.push(d[g].name);for(a.push(f.join("	"));c>b;b++){for(var h=[],g=0;g<d.length;g++)e.getValueFromJPath(this.elements[b],d[g].jpath).done(function(a){h.push(a)});a.push(h.join("	"))}return a.join("\r\n")}}}),g});