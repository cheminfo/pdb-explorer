"use strict";require.config({paths:{"d3-plugins":"components/d3-plugins"},shim:{"d3-plugins":"d3"}}),define(["modules/default/defaultview","lodash","src/util/debug","src/util/util","d3","src/util/color","src/util/colorbar","src/util/ui","d3-plugins/hexbin/hexbin"],function(a,b,c,d,e,f,g,h){function i(){}function j(a){try{a.data[0].x}catch(a){return c.warn("no chart data"),[]}for(var b=[],d=void 0!==a.data[0].z,e=0;e<a.data.length;e++)for(var f=0;f<a.data[e].x.length;f++){var g=[a.data[e].x[f],a.data[e].y[f]];d&&g.push(a.data[e].z[f]),b.push(g)}return b}function k(a){return void 0===a||3!==a.length||a[0]+a[1]+a[2]!==0?!1:!0}function l(a){for(var b=[],c=0;c<a.length;c++){var d=a[c],e=Math.min.apply(null,d),f=Math.max.apply(null,d);if(0===e&&3===d.length){var g=d.indexOf(e),h=d.indexOf(f),i=2*(g+h)%3,j=[0,0,0];j=n(j,s(d,g,i,h)),j=n(j,r(d,g,i,h)),b.push(j)}else b.push(void 0)}return b}function m(a){for(var b=new Array(a.length),c=0;c<a.length;c++)if(k(a[c])){var d=a[c][2],e=a[c][0],f=e+(d-(1&d))/2;b[c]=[f,d]}return b}function n(a,b){if(a.length!==b.length)throw new Error("Array not the same size in addition");for(var c=a.slice(0),d=0;d<a.length;d++)c[d]+=b[d];return c}function o(a,b){for(var c=a.slice(0),d=0;d<a.length;d++)c[d]*=b;return c}function p(a,b){for(var c=a.slice(0),d=0;d<a.length;d++)c[d]+=b;return c}function q(a,b){for(var c=new Array(b),d=0;d<c.length;d++)c[d]=a;return c}function r(a,b,c,d){return b===c?[0,0,0]:0===c&&1===d||1===c&&0===d?o([1,-1,0],a[c]):1===c&&2===d||2===c&&1===d?o([0,1,-1],a[c]):o([-1,0,1],a[c])}function s(a,b,c,d){return c===d?[0,0,0]:0===d?o([0,-1,1],a[d]-a[c]):1===d?o([1,0,-1],a[d]-a[c]):o([-1,1,0],a[d]-a[c])}function t(a,b){for(var c=0,d=0;d<a.length;d++)a[d]===b[d]&&a[d]>c&&(c=a[d]);return c}function u(a){return[{x:a*Math.cos(-Math.PI/3),y:a*Math.sin(Math.PI/3)},{x:a*Math.cos(2*Math.PI/3),y:a*Math.sin(2*-Math.PI/3)},{x:a*Math.cos(Math.PI/3),y:a*Math.sin(-Math.PI/3)},{x:a*Math.cos(2*-Math.PI/3),y:a*Math.sin(2*Math.PI/3)},{x:a*Math.cos(Math.PI),y:a*Math.sin(Math.PI)},{x:a*Math.cos(0),y:a*Math.sin(0)}]}var v="lightblue";return i.prototype=$.extend(!0,{},a,{init:function(){},inDom:function(){this.id=d.getNextUniqueId(),this.dom=h.getSafeElement("div").attr("id",this.id),this.module.getDomContent().html(this.dom),this.resolveReady()},blank:{chart:function(){this.reset()}},update:{chart:function(a){this.ignored=[],this.chart=a.get();var b=j(this.chart);switch(this.originalData=b,this.coordinateSystem=this.module.getConfiguration("coordinateSystem"),this.axesType=this.module.getConfiguration("axesType"),this.layout="vertical",this.coordinateSystem){case"combinatorial":this.origin=[this.module.getConfiguration("originX"),this.module.getConfiguration("originY"),this.module.getConfiguration("originZ")],this.data=b,this._substractOrigin(),this._combinatorialBoundaries(this.data),this.data=l(this.data),this.cubicData=this.data,this.data=m(this.data);break;default:this.data=b}this._chartData(),this._ignored(),this._normalize(),this._processColors(),this.draw()}},_substractOrigin:function(){for(var a=0;a<this.data.length;a++)this.data[a]=n(this.data[a],o(this.origin,-1))},_combinatorialBoundaries:function(){var a=b.pluck(this.originalData,0),c=b.pluck(this.originalData,1),d=b.pluck(this.originalData,2);this.combXmin=Math.min.apply(null,a),this.combYmin=Math.min.apply(null,c),this.combZmin=Math.min.apply(null,d),this.combXmax=Math.max.apply(null,a),this.combYmax=Math.max.apply(null,c),this.combZmax=Math.max.apply(null,d),this.combXYmax=t(a,c),this.combXZmax=t(a,d),this.combYZmax=t(c,d)},_reMinMax:function(a){this.minX=Math.min(this.minX,Math.min.apply(null,b.pluck(a,0))),this.minY=Math.min(this.minY,Math.min.apply(null,b.pluck(a,1))),this.maxX=Math.max(this.maxX,Math.max.apply(null,b.pluck(a,0))),this.maxY=Math.max(this.maxX,Math.max.apply(null,b.pluck(a,1))),this.lenX=this.maxX-this.minX,this.lenY=this.maxY-this.minY},_normalize:function(){var a=b.pluck(this.data,0),c=b.pluck(this.data,1),d=Math.min.apply(null,a),e=Math.min.apply(null,c),f=Math.max.apply(null,a),g=Math.max.apply(null,c);this.lenX=f-d,this.lenY=g-e;var h=Math.min(d,e);h%2!==0&&(h-=1),this.normConstant=-h;for(var i=0;i<this.data.length;i++)this.data[i][0]+=this.normConstant,this.data[i][1]+=this.normConstant;this.minX=d+this.normConstant,this.minY=e+this.normConstant,this.maxX=f+this.normConstant,this.maxY=g+this.normConstant},_ignored:function(){for(var a=[],c=0;c<this.data.length;c++)void 0===this.data[c]&&a.push(c);this.totalSize=this.data.length,this.realSize=this.data.length-a.length,b.pullAt(this.data,a),b.pullAt(this.color,a),b.pullAt(this.cubicData,a),b.pullAt(this.originalData,a),b.pullAt(this.label,a)},_processColors:function(){var a=this.module.getConfiguration("gradient"),c=this.module.getConfiguration("stopType");a=b.filter(a,function(a){return void 0!==a.stopPosition}),this.stopPositions=b.pluck(a,"stopPosition"),"percent"===c?(this.colorDomain=b.filter(this.color,function(a){return!isNaN(a)}),this.colorDomain=[Math.min.apply(null,this.colorDomain),Math.max.apply(null,this.colorDomain)]):this.colorDomain=[Math.min.apply(null,this.stopPositions),Math.max.apply(null,this.stopPositions)],this.stopColors=b(a).pluck("color").map(f.getColor).value(),this.numberToColor=g.getColorScale({stops:this.stopColors,stopPositions:this.stopPositions,domain:this.colorDomain,stopType:c});for(var d=0;d<this.color.length;d++)if(!isNaN(this.color[d])){var e=this.numberToColor(this.color[d]);this.color[d]=e.color,this.opacity[d]=e.opacity}this.color=this.color.map(function(a){return void 0===a?v:a}),this.opacity=this.opacity.map(function(a){return void 0===a?1:a}),console.log(this.color)},_fontSize:function(a){function b(b){var c=b.split("\n"),e=c.reduce(function(a,b){return Math.max(a,b.length)},0);return e=Math.max(e,c.length),e?a/e*2:d}var c,d=50;return(c=this.module.getConfiguration("fontSize"))||(c=this.label.reduce(function(a,c){return c?Math.min(a,b(c)):a},d)),(0|c)+"px"},_chartData:function(){this.color=[],this.label=[],this.opacity=[];for(var a=0;a<this.chart.data.length;a++){var c=this.chart.data[a];this.color.push(b.pluck(c.info,"color")),this.label.push(b.pluck(c.info,"label")),this.opacity.push(b.pluck(c.info,"opacity"))}this.color=b.flatten(this.color),this.label=b.flatten(this.label),this.opacity=b.flatten(this.opacity),this.chart.axis&&(this.axes=this.chart.axis)},onResize:function(){this.redraw()},draw:function(){if("combinatorial"===this.coordinateSystem&&this.axes&&"none"!==this.axesType){this.axeData={};var a=3;this.axeData.points=[[this.combXmax+a,0,0],[0,this.combYZmax+a,this.combYZmax+a],[0,this.combYmax+a,0],[this.combXZmax+a,0,this.combXZmax+a],[0,0,this.combZmax+a],[this.combXYmax+a,this.combXYmax+a,0]];var b=1,c=2;this.axeData.startPoints=[[this.combXmax+b,0,0],[0,this.combYZmax+b,this.combYZmax+b],[0,this.combYmax+b,0],[this.combXZmax+b,0,this.combXZmax+b],[0,0,this.combZmax+b],[this.combXYmax+b,this.combXYmax+b,0]],this.axeData.endPoints=[[this.combXmax+c,0,0],[0,this.combYZmax+c,this.combYZmax+c],[0,this.combYmax+c,0],[this.combXZmax+c,0,this.combXZmax+c],[0,0,this.combZmax+c],[this.combXYmax+c,this.combXYmax+c,0]],this.axeLabels=[this.axes[0].name,this.axes[1].name+this.axes[2].name,this.axes[1].name,this.axes[0].name+this.axes[2].name,this.axes[2].name,this.axes[0].name+this.axes[1].name],this.axeData.points=l(this.axeData.points),this.axeData.points=m(this.axeData.points),this.axeData.startPoints=l(this.axeData.startPoints),this.axeData.startPoints=m(this.axeData.startPoints),this.axeData.endPoints=l(this.axeData.endPoints),this.axeData.endPoints=m(this.axeData.endPoints);for(var d=0;d<this.axeData.points.length;d++)this.axeData.points[d]=p(this.axeData.points[d],this.normConstant),this.axeData.startPoints[d]=p(this.axeData.startPoints[d],this.normConstant),this.axeData.endPoints[d]=p(this.axeData.endPoints[d],this.normConstant);this._reMinMax(this.axeData.points)}this.redraw()},redraw:function(){function a(a){return[a[0]*i*1.75,a[1]*i*1.5]}function c(){p.attr("transform","translate("+e.event.translate+")scale("+e.event.scale+")")}if(this.data&&0!==this.data.length){var d=this;this.reset();for(var f=this.dom.width()/(2+1.5*this.lenX),h=this.dom.height()/(1.75*(this.lenX+1)),i=Math.min(f,h),j=[],k=0;k<this.data.length;k++)j.push(a(this.data[k]));var l=b.flatten([a([this.minX-.3,this.minY-.8]),a([this.lenX+1.5,this.lenY+1.5])]);this.module.getConfigurationCheckbox("showColorBar","show")&&(l[0]-=100,l[2]+=100);var m=this.width,n=this.height,o=e.select("#"+this.id).append("svg").attr("viewBox",l.join(",")).attr("width",m).attr("height",n).style("display","block"),p=o.append("g"),r=this.module.getConfiguration("tickMode"),s=this.module.getConfiguration("tickNumber"),t=(this.module.getConfiguration("tickValues")||"").split(",").map(function(a){return+a});if(this.module.getConfigurationCheckbox("showColorBar","show")){var v=l[0],w=l[1],x=g.getSvg({width:20,height:.95*l[3]-20,axis:{orientation:"left",ticks:"auto"===r?s:void 0,tickValues:"manual"===r?t:void 0,order:"asc"},stops:this.stopColors,stopPositions:this.stopPositions,domain:this.colorDomain,stopType:this.module.getConfiguration("stopType")});x='<g transform="translate('+v+","+w+')">'+x+"</g>",p.html(x)}var y=e.hexbin().radius(i),z=d._fontSize(i);if("combinatorial"===this.coordinateSystem&&this.axes)if(p.append("defs").selectAll("marker").data(["normal"]).enter().append("marker").attr("id",function(a){return a}).attr("viewBox","0 -5 10 10").attr("refX",10).attr("refY",0).attr("markerWidth",10).attr("markerHeight",10).attr("orient","auto").append("path").attr("d","M0,-4L10,0L0,4"),"graph"===this.axesType){var A=[],B=[],C=[];for(k=0;k<this.axeData.points.length;k++)A.push(a(this.axeData.points[k])),B.push(a(this.axeData.startPoints[k])),C.push(a(this.axeData.endPoints[k]));B=y(B),C=y(C),A=y(A),p.append("g").selectAll(".axes").data(A).enter().append("foreignObject").style("pointer-events","none").attr({width:i,height:i}).attr("transform",function(a){return"translate("+(a.x-i/2)+","+(a.y-i/2)+")"}).append("xhtml:div").append("div").style({display:"flex",height:""+i+"px",width:""+i+"px","box-sizing":"border-box","align-items":"center","font-size":z}).attr("class","axe-text").html(function(a,b){return d.axeLabels[b]}),p.append("g").selectAll(".axe-arrow").data(A).enter().append("path").attr("class","axe-arrow").attr("marker-end","url(#normal)").attr("d",function(a,b){return"M"+B[b].x+","+B[b].y+"L"+C[b].x+" "+C[b].y})}else if("legend"===this.axesType){var D=30,E=20,F=u(D),G=u(E),H=q({x:0,y:0},6),I=20;p.append("g").attr("class","abcd").selectAll(".axes-legend").data(F).enter().append("foreignObject").style("pointer-events","none").attr({width:I,height:I}).attr("transform",function(a){return"translate("+(a.x-l[0]-I/2)+","+(a.y+l[1]+D-I/2)+")"}).append("xhtml:div").append("div").style({display:"flex",height:""+i+"px",width:""+i+"px","box-sizing":"border-box","font-size":16,"align-items":"center"}).attr("class","axe-corner-text").html(function(a,b){return d.axeLabels[b]}),p.append("g").selectAll(".axe-arrow-legend").data(H).enter().append("path").attr("class","axe-arrow-legend").attr("marker-end","url(#normal)").attr("d",function(a,b){return"M"+(H[b].x-l[0]-4)+","+(H[b].y+l[1]+D)+"L"+(G[b].x-l[0]-4)+" "+(G[b].y+l[1]+D)})}var J=y(j);p.append("g").selectAll(".hexagon").data(J).enter().append("path").attr("class","hexagon").attr("d",function(a){return"M"+a.x+","+a.y+y.hexagon()}).attr("stroke","black").attr("stroke-width","1px").style("fill",function(a,b){return d.color[b]}).style("fill-opacity",function(a,b){return d.opacity[b]});var K=p.append("g").selectAll("foreignObject").data(J).enter().append("foreignObject").style("pointer-events","none").attr({width:i,height:i,transform:function(a){return"translate("+(a.x-i/2)+","+(a.y-i/2)+")"}});if(K.append("xhtml:div").append("div").style({display:"flex",height:""+i+"px",width:""+i+"px",padding:0,"align-items":"center","justify-content":"center","box-sizing":"border-box","font-size":z}).html(function(a,b){return d.label[b]}),this.module.getConfigurationCheckbox("enableZoom","yes")){var L=e.behavior.zoom().scaleExtent([.2,10]).on("zoom",c);o.call(L).on("dblclick.zoom",function(){L.scale(1),L.translate([0,0]),L.event(o)})}}},reset:function(){this.dom.html("")}}),i});