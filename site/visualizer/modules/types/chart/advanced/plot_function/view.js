"use strict";define(["require","modules/default/defaultview","src/util/util","threejs","src/util/debug","lib/parser/Parser","lib/threejs/TrackballControls"],function(a,b,c,d,e,f){function g(){}return $.extend(!0,g.prototype,b,{init:function(){var a=this;this.webgl=function(){try{return!!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(a){return!1}}();var b=$.proxy(a.module.getConfiguration,a.module);this._id=c.getNextUniqueId();var d=$("<div>",{Id:this._id});d.css("display","table").css("height","100%").css("width","100%").css("overflow","hidden"),this.dom=d,this.module.getDomContent().html(this.dom).css("overflow","hidden"),this.zFunctionText=b("function")||"sin(sqrt(0.01*x^2  + 0.01*y^2))*10",this.xMin=b("xMin")||-100,this.xMax=b("xMax")||100,this.yMin=b("yMin")||-100,this.yMax=b("yMax")||100,this.zMin=b("zMin")||-100,this.zMax=b("zMax")||100,this.xRange=this.xMax-this.xMin,this.yRange=this.yMax-this.yMin,this.clearScene(),this.createGraph(),this.resolveReady(),this.doAnimation=!1,this.dom.on("mouseenter",function(){a.doAnimation=!0}),this.dom.on("mouseleave",function(){a.doAnimation=!1})},clearScene:function(){this.scene&&(this.scene.remove(this.graphGeometry),this.scene.remove(this.graphMesh),this.scene.remove(this.floor),delete this.graphGeometry,delete this.graphMesh,delete this.floor)},blank:{function:function(){this.clearScene()}},onResize:function(){if(!this.webgl)return void e.warn("webgl context does not exist");var b=this;this.module.viewReady.then(function(){var c=$.proxy(b.module.getConfiguration,b.module);c("segments");b.graphMesh&&b.scene.remove(b.graphMesh);var e=d.ImageUtils.loadTexture(a.toUrl("./square.png"));e.wrapS=e.wrapT=d.RepeatWrapping,e.repeat.set(40,40);var f=new d.MeshBasicMaterial({map:e,vertexColors:d.VertexColors,side:d.DoubleSide});b.graphMesh=new d.Mesh(b.graphGeometry,f),b.graphMesh.doubleSided=!0,b.scene.add(b.graphMesh),b.renderer.setSize(b.width,b.height),b.setCamera(),b.setControls(),b.firstAnimation=60,b.animate()})},addFloor:function(a){var b=new d.MeshBasicMaterial({color:136,wireframe:!0,side:d.DoubleSide}),c=new d.PlaneBufferGeometry(1e3,1e3,10,10);this.floor=new d.Mesh(c,b),a.add(this.floor)},update:{function:function(a){this.zFunctionText=a.get(),this.createGraph(),this.onResize()}},animate:function(){var a=this;requestAnimationFrame(a.animate.bind(a)),(a.doAnimation||a.firstAnimation>0)&&(a.firstAnimation>0&&a.firstAnimation--,a.renderer.render(a.scene,a.camera),a.controls.update())},setCamera:function(){var a=45,b=this.width/this.height,c=.1,e=2e4;this.camera=new d.PerspectiveCamera(a,b,c,e),this.camera.position.set(2*this.xMax,.5*this.yMax,4*this.zMax),this.camera.up=new d.Vector3(0,0,1),this.camera.lookAt(this.scene.position),this.scene.add(this.camera)},setControls:function(){this.controls=new d.TrackballControls(this.camera,this.renderer.domElement)},createGraph:function(){var a=this,b=$.proxy(a.module.getConfiguration,a.module),c=b("segments"),e=f.parse(a.zFunctionText).toJSFunction(["x","y"]),g=function(b,c){b=a.xRange*b+a.xMin,c=a.yRange*c+a.yMin;var f=e(b,c);return isNaN(f)?new d.Vector3(0,0,0):new d.Vector3(b,c,f)},h=new d.ParametricGeometry(g,c,c,!0);h.computeBoundingBox(),a.zMin=h.boundingBox.min.z,a.zMax=h.boundingBox.max.z,a.zRange=a.zMax-a.zMin;for(var i,j,k,l,m,n=["a","b","c","d"],o=0;o<h.vertices.length;o++)j=h.vertices[o],i=new d.Color(255),i.setHSL(.7*(a.zMax-j.z)/a.zRange,1,.5),h.colors[o]=i;for(var o=0;o<h.faces.length;o++){k=h.faces[o],l=k instanceof d.Face3?3:4;for(var p=0;l>p;p++)m=k[n[p]],k.vertexColors[p]=h.colors[m]}a.graphGeometry=h,a.scene=new d.Scene,a.renderer||(a.webgl?a.renderer=new d.WebGLRenderer({antialias:!0}):a.renderer=new d.CanvasRenderer,a.renderer.setClearColor(15658734,1)),a.dom.append(a.renderer.domElement),a.addFloor(a.scene)}}),g});